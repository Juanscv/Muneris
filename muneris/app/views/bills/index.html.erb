<h1>Listing bills</h1>

<%= define_grid(@bills_grid, hide_submit_button: true) do |g|

  g.blank_slate  "No records found"

  g.column name: 'Consumption', attribute: 'consumption', auto_reload:  true, detach_with_id: :consumption_filter do |bill|
    case bill.service
    when 1
      bill.consumption.to_s + " kWh"
    when 2
      bill.cosumption.to_s + " m3"
    when 3
      bill.consumption.to_s + " m3"
    end
  end

  g.column  name: 'Payment', attribute: 'value', auto_reload:  true, detach_with_id: :value_filter do |bill|
    number_to_currency(bill.value, :precision => 0)
  end

  g.column name: 'Date', attribute: 'date', auto_reload:  true, detach_with_id: :date_added, helper_style: :standard

  g.column name: 'Type of bill', attribute: 'service', auto_reload: true, detach_with_id: :service_filter, custom_filter: [['Energy Bill',1],['Water Bill',2],['Gas Bill',3]] do |bill|
    case bill.service
    when 1
      "Energy"
    when 2
      "Water"
    when 3
      "Gas"
    end
  end

  g.column do |bill|
    link_to 'Show', bill
  end

  g.column do |bill|
    link_to'Edit', edit_bill_path(bill)
  end

  g.column do |bill|
    link_to 'Destroy', bill, method: :delete, data: { confirm: 'Are you sure?' }
  end

end -%>


<div class="w-container">

  <div class="w-row">
    <div class="w-col w-col-3">
      <div class ="wg-detached-filter">
        <div>Consumption: <%= grid_filter @bills_grid, :consumption_filter %></div>
        
        <div>Payment:  <%= grid_filter @bills_grid, :value_filter %></div>

        <div>Type of bill:  <%= grid_filter @bills_grid, :service_filter %></div>

        <div>Date: <%= grid_filter @bills_grid, :date_added %></div>

        <div class="external-buttons w-container ">
          <button class="clickable w-button" data-grid-name="grid">Reset</button>
        </div>

      </div>
      <div class="w-row">
        <div class="w-col w-col-2">
          <%= link_to image_tag("add.png"), new_bill_path %>
        </div>
        <div class="w-col w-col-10">
          <h4><%= link_to 'New Bill', new_bill_path, class: "profile-sections" %></h4>
        </div>        
      </div>

    </div>

    <div class="w-col w-col-8">

      <div class="wice-grid">

      <%= render_grid(@bills_grid) %>

      </div>

      <%
        @chart = LazyHighCharts::HighChart.new('graph') do |f|
          f.title(:text => "Bill history")
          f.xAxis(:categories => Date.months_between(@all_records.map(&:date).min,@all_records.map(&:date).max))
          f.yAxis({:title => {:text => "Consumption", :margin => 20} })

          f.series(name: "Energy bills", :yAxis => 0, :data => @all_records.map{|x| x.consumption if x.service == 1})
          f.series(name: "Water bills", :yAxis => 0, :data => @all_records.map{|x| x.consumption if x.service == 2})
          f.series(name: "Gas bills", :yAxis => 0, :data => @all_records.map{|x| x.consumption if x.service == 3})

          f.legend(:align => 'center', :verticalAlign => 'top', :y => 30)         
        end %>
      
      <%=  high_chart("my_id", @chart) %>

    </div>
  </div>

<div id="container" style="height: 400px; min-width: 310px"></div>
    <script  type="text/javascript">
    $(function() {
      var seriesOptions = [],
        yAxisOptions = [],
        seriesCounter = 0,
        names = ['MSFT', 'AAPL', 'GOOG'],
        colors = Highcharts.getOptions().colors;

      $.each(names, function(i, name) {

        $.getJSON('http://www.highcharts.com/samples/data/jsonp.php?filename='+ name.toLowerCase() +'-c.json&callback=?', function(data) {

          seriesOptions[i] = {
            name: name,
            data: data
          };

          // As we're loading the data asynchronously, we don't know what order it will arrive. So
          // we keep a counter and create the chart when all the data is loaded.
          seriesCounter++;

          if (seriesCounter == names.length) {
            createChart();
          }
        });
      });



      // create the chart when all data is loaded
      function createChart() {

        $('#container').highcharts('StockChart', {

            rangeSelector: {
            inputEnabled: $('#container').width() > 480,
                selected: 4
            },

            yAxis: {
              labels: {
                formatter: function() {
                  return (this.value > 0 ? '+' : '') + this.value + '%';
                }
              },
              plotLines: [{
                value: 0,
                width: 2,
                color: 'silver'
              }]
            },
            
            plotOptions: {
              series: {
                compare: 'percent'
              }
            },
            
            tooltip: {
              pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
              valueDecimals: 2
            },
            
            series: seriesOptions
        });
      }

    });

    </script>
  
</div>


